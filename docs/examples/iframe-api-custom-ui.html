<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>Iframe API - Barney Viewer API Demos</title>
	<link rel="stylesheet" href="../assets/main.css">

	<!-- /!\ Not safe for PROD: early access of the viewer API -->
	
	<!-- Barney Viewer API -->
	<script>(function(B,a,r,n,e,y,_3,D){_3=B[e]||(B[e]={}),_3[n]||(_3[n]=function(c)
	{(_3[n].l||(_3[n].l=[])).push(c);}),D=a.createElement(r),D.async=!0,D.src=y,
	a.head.appendChild(D);}(window,document,'script','onReady','Barney',
	'https://staging-viewer.barney-technologies.com/api.js'));</script>
	<!-- End Barney Viewer API -->

</head>
<body>


	<div id="wrap">
		
		<h1>Custom UI with iframe API</h1>

		<div class="lorem small"></div>

		<div id="viewer">
			<div class="zoom" style="display:none">
				<a class="zoom__in" href="javascript:void(0)"></a>
				<a class="zoom__out" href="javascript:void(0)"></a>
			</div>
			<div class="loading" style="display:none"></div>
			<div class="interaction-prompt" style="display:none"></div>
		</div>

		<div class="lorem large"></div>

		<script>
			Barney.onReady(() => {

				/* -------------------------
					DOM
				------------------------- */

				// Viewer container
				const viewerWrap = document.querySelector('#viewer')

				// Custom viewer elements
				const loading = viewerWrap.querySelector('.loading')
				const zoomWrap = viewerWrap.querySelector('.zoom')
				const zoomInBtn = viewerWrap.querySelector('.zoom__in')
				const zoomOutBtn = viewerWrap.querySelector('.zoom__out')
				const intPrompt = viewerWrap.querySelector('.interaction-prompt')


				/* -------------------------
					VIEWER API
				------------------------- */
				
				const viewer = new Barney.ViewerIframe(viewerWrap, {

					// /!\ Not safe for PROD: early access of the viewer API
					host: 'https://staging-viewer.barney-technologies.com',

					itemId: '4b3f9d86d284e6c83d195268',

					viewerVars: {

						// Enable turntable animation
						'autorotate': true,
						// But change the "restart delay" to 1 second
						'autorotate-delay': 1000,

						// Mouse wheel won't block the scroll and don't show any message
						'mouse': 'cooperative-silent',

						// Don't show the default loading animation
						'loading-style': 'none',

						// Don't show the default "Hold and rotate" message
						'interaction-prompt-style': 'none',

						// Force the language of the viewer
						'lang': 'en',

					}
				})

				viewer.one('loadingProgress', (progress) => {
					// First loading progress event (note the 'one()' listener)
					loading.style.display = ''
				})

				viewer.on('loadingProgress', (progress) => {
					// Progress is a number between 0 and 1
					loading.innerText = Math.round(progress * 100) + '%'
				})

				viewer.on('ready', () => {
					// All the viewer is ready to render frames
					console.log('Ready → show controls + interaction prompt')

					loading.style.display = 'none'

					zoomWrap.style.display = ''

					intPrompt.style.display = ''
					intPrompt.innerText = isTouch()
						? "Touch and hold to rotate"
						: "Click and hold to rotate"
				})

				viewer.one('interactionStart', () => {
					// First user interaction (note the 'one()' listener)
					console.log('First interaction → hide custom interaction prompt')
					intPrompt.style.display = 'none'
				})


				/* -------------------------
					UTIL
				------------------------- */

				function isTouch() {
					return ('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch
				}


				/* -------------------------
					HANDLING ZOOM
				------------------------- */

				// Speed of the zoom on pressing the button once
				const ZOOM_CLICK_SPEED = 3
				// Speed if we keep pressing the button. It's important to
				// use per-second calcs to have consistent behavior on every
				// device whatever its screen refresh rate (60hz, 144hz...)
				const ZOOM_PRESS_SPEED_PER_SECOND = 15
				
				let zoomDirection = 0 // 0 for no zoom, 1 for zoom in, -1 for zoom out
				let zoomTimeout = null
				let zoomLastTime = null

				// Prevent long touch press from opening the context menu
				zoomInBtn.addEventListener('contextmenu', (e) => e.preventDefault())
				zoomOutBtn.addEventListener('contextmenu', (e) => e.preventDefault())

				// Listen for mouse and touch press of the buttons
				zoomInBtn.addEventListener('pointerdown', (e) => onZoomDown(1))
				zoomOutBtn.addEventListener('pointerdown', (e) => onZoomDown(-1))

				function onZoomDown(direction) {
					zoomDirection = direction
					
					// Listen for the release of the button
					window.addEventListener('pointerup', onZoomUp)
					window.addEventListener('pointercancel', onZoomUp)

					// One big zoom in/out on press
					viewer.zoomIn(ZOOM_CLICK_SPEED * zoomDirection)

					// And wait a little before considering the 'button press'
					if (zoomTimeout) clearTimeout(zoomTimeout)
					zoomTimeout = setTimeout(() => whileZoomPressed(), 250)
				}

				function onZoomUp(event) {
					// Remove listeners
					window.removeEventListener('pointerup', onZoomUp)
					window.removeEventListener('pointercancel', onZoomUp)

					// Stop pending timeout
					if (zoomTimeout) clearTimeout(zoomTimeout)
					zoomTimeout = null

					// Reset vars
					zoomDirection = 0
					zoomLastTime = null
				}

				function whileZoomPressed(time) {
					if (!zoomDirection) return

					// Calc the "per second" factor to apply
					if (zoomLastTime === null) zoomLastTime = time
					const delta = (time - zoomLastTime) / 1000
					// If it's a correct number, send it to the viewer
					if (!isNaN(delta)) viewer.zoomIn(ZOOM_PRESS_SPEED_PER_SECOND * delta * zoomDirection)

					// Store value + call next frame
					zoomLastTime = time
					requestAnimationFrame(whileZoomPressed)
				}

			})
		</script>

		<style>

			/* -------------------------
				VIEWER 16:9
			------------------------- */

			#viewer {
				position: relative;
			}
			#viewer::before {
				content: '';
				display: block;
				padding-bottom: 56.25%;
			}
			#viewer iframe {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}

			/* -------------------------
				LOADING
			------------------------- */

			#viewer .loading {
				width: 4em;
				height: 4em;
				display: flex;
				align-items: center;
				justify-content: center;
				
				margin: -2em;
				z-index: 1;
				position: absolute;
				top: 50%;
				right: 50%;

				color: #333;
				font-weight: bold;
				font-size: 20px;

				border-radius: 50%;
				background-color: rgba(255, 255, 255, 0.8);
				pointer-events: none;
			}

			/* -------------------------
				ZOOM
			------------------------- */
			
			#viewer .zoom {
				z-index: 1;
				margin: -40px -2px;
				position: absolute;
				top: 50%;
				right: 20px;
				display: flex;
				flex-flow: column nowrap;
			}
			
			#viewer .zoom__in,
			#viewer .zoom__out {
				margin: 2px;
				display: block;
				width: 36px;
				height: 36px;
				line-height: 36px;
				text-align: center;
				font-weight: bold;
				font-size: 20px;
				text-decoration: none;
				color: #fff;
				position: relative;
				background-color: rgba(0, 0, 0, 0.8);
			}
			
			#viewer .zoom__in::before,
			#viewer .zoom__in::after,
			#viewer .zoom__out::before {
				content: '';
				display: block;
				width: 16px;
				height: 2px;
				position: absolute;
				top: 50%;
				left: 50%;
				margin: -1px -8px;
				background-color: #fff;
			}
			#viewer .zoom__in::after {
				transform: rotate(90deg);
			}

			/* -------------------------
				INTERACTION PROMPT
			------------------------- */

			#viewer .interaction-prompt {
				max-width: 80%;
				padding: 10px 20px;

				z-index: 1;
				transform: translate(-50%, 0);
				position: absolute;
				left: 50%;
				bottom: 20px;

				color: #333;
				font-weight: bold;
				font-size: 16px;

				background-color: rgba(255, 255, 255, 0.8);
				pointer-events: none;
			}

		</style>

	</div>

</body>
</html>